id: serverboards.core.ssh
name: Core SSH support
author: David Moreno <dmoreno@serverboards.io>
version: 17.04
description: >
  Performs core operations needed for SSH connectivity to hosts.

  This may be used by other plugins to achieve their own goals.

components:
  - name: SSH access
    type: service
    traits: ssh url
    id: ssh
    description: Access via SSH to any server
    icon: terminal
    fields:
      - label: SSH Address
        name: url
        type: text
        validation: empty
        card: true
      - label: SSH `Host` Options
        description: |
          This settings will be applied to all SSH connections. Please check the
          [ssh documentation](https://linux.die.net/man/5/ssh_config) for all
          options.

          Enter one option per line.
        placeholder: |
          eg:
          User remoteuser
          ProxyCommand ssh real.host.com -qW  192.168.1.2:22
          LocalCommand sudo bash
        type: textarea
        name: options
      - label: SSH Public Key
        type: description
        description: |
          To connect via SSH please ensure that the following SSH public key is
          added to your servers `~/.ssh/authorized_keys`:

          **SSH Public Key:**

          ```
          {{ssh_key}}
          ```
        vars:
          - id: ssh_key
            command: serverboards.core.ssh/mgmt
            call: ssh_public_key
      - label: Remote SSH Fingerprint
        type: button
        show_if: url
        depends_on: url
        description: |
          The remote fingerprints are:

          ```
          {{status.fingerprint}}
          ```
          Click on "Enable host" to add to your known_hosts. This is required to access this server.
        value: "{{status.toggle}}"
        className: "{{status.className}}"
        onclick:
            command: serverboards.core.ssh/mgmt
            call: toggle_remote_fingerprint
        vars:
          - id: status
            command: serverboards.core.ssh/mgmt
            call: remote_fingerprint

  - name: SSH Management
    id: management
    description: Screen on which to view known peers
    type: settings/section
    screen:
      html: static/index.html
      js: static/index.js

  - name: SSH Terminal
    id: terminal
    description: Can access via SSH to server
    type: screen
    traits: ssh
    icon: terminal

  - name: Execute SSH Command
    id: exec
    type: action
    command: daemon
    description: Executes a remote command. It is recommended that the key exchange is configured prior, so no ssh passwords are stored on the database.
    traits: ssh
    icon: terminal
    call:
      method: ssh_exec
      params:
        - name: url
          type: url
          label: Connection url
          placeholder: eg. ssh://username:password@hostname:port/
        - name: options
          type: textarea
          label: SSH Connection options
          placeholder: eg. ProxyCommand ssh proxyserver -qW destserver:22
        - name: command
          type: text
          label: Command to execute
          description: Non blocking command to execute
  - name: SSH daemon
    id: daemon
    type: cmd
    timeout: 24h
    strategy: singleton
    perms: event.emit settings.view[serverboards.core.ssh/ssh.settings]
    command: serverboards-ssh.py

  - name: SSH Management
    id: mgmt
    type: cmd
    timeout: 10s
    strategy: singleton
    perms: event.emit
    command: serverboards-ssh-mgmt.py

  - name: General SSH Settings
    id: ssh.settings
    type: settings
    perms: settings
    fields:
      - label: SSH `Host *` Options
        description: |
          This settings will be applied to all SSH connections. Please check the
          [ssh documentation](https://linux.die.net/man/5/ssh_config) for all
          options.

          Enter one option per line.
        placeholder: |
          eg:
          ControlMaster auto
          ControlPath /tmp/ssh-%h%p%r
          ControlPersist 600
        type: textarea
        name: options
