!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";var e=Serverboards,t=e.React,r=e.i18n,n=Serverboards.Components.HoldButton;var a=t.createClass({displayName:"Header",componentDidMount:function(){$(this.refs.secret_select).dropdown({})},handleSecretSelect:function(e){e.target.value&&this.props.onSecretSelect(e.target.value)},componentWillReceiveProps:function(e){var t=this;e.secret!=this.props.secret&&setTimeout(function(){e.secret?$(t.refs.secret_select).dropdown("set selected",e.secret):$(t.refs.secret_select).dropdown("clear")},20)},render:function(){var e=this.props;return console.log("Secrets: ",e.secrets,e.onDelete),t.createElement("div",{className:"ui top secondary menu"},t.createElement("div",{className:"right menu"},t.createElement(n,{className:"ui outline button red "+(e.onDelete?"":"disabled"),onHoldClick:e.onDelete},r("Hold to remove")),t.createElement("select",{className:"ui dropdown search small",name:"secret",ref:"secret_select",onChange:this.handleSecretSelect,value:e.secret},t.createElement("option",{value:""},"Select a secret"),function(e){return e.sort(),e}(Object.keys(e.secrets)).map(function(r){return t.createElement("option",{key:r,value:r},e.secrets[r])})),t.createElement("a",{className:"item",onClick:e.onSecretAdd},t.createElement("i",{className:"ui icon add"}))))}}),s=Serverboards.React;function i(e){return s.createElement("div",{className:"ui container with padding"},s.createElement("div",{className:"ui form"},s.createElement("div",{className:"field"},s.createElement("label",null,"Password"),s.createElement("input",{type:"password",id:"password",placeholder:"Secret password"})),s.createElement("div",{className:"field"},s.createElement("button",{className:"ui button yellow",onClick:function(){var t=$("#secrets input#password").val();e.onPasswordSet(t)}},"Decrypt ",s.createElement("i",{className:"ui icon right arrow"})))))}var l=Serverboards.React,c={document:"file text",text:"file text","application/vnd.oasis.opendocument.spreadsheet":"file excel outline",image:"file image"},o={verticalAlign:"top"};function d(e){var t=e.data.slice(5,e.data.indexOf(";"));switch(console.log(e.data.slice(0,20),t),t){case"image/gif":case"image/svg":case"image/png":case"image/jpg":case"image/jpeg":return l.createElement("img",{src:e.data,className:"ui top aligned avatar image"})}return c[t]?l.createElement("i",{style:o,className:"icon big black "+c[t]}):(t=t.slice(t.indexOf("/")),c[t]?l.createElement("i",{style:o,className:"icon big black "+c[t]}):l.createElement("i",{style:o,className:"icon big black file"}))}var u=Serverboards.React;function p(e){return 1024>e?e+" Bytes":1048576>e?(e/1024).toFixed(2)+" KB":1073741824>e?(e/1048576).toFixed(2)+" MB":void 0}function m(e){return u.createElement("div",null,u.createElement(d,e),u.createElement("div",{style:{display:"inline-block"}},u.createElement("div",null,e.name),u.createElement("div",{className:"ui meta"},p(e.size)||"~ "+p(3*e.data.length/4))))}var h=Serverboards.plugin,f={uuid4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random();return("x"==e?t:8|3&t).toString(16)})}};h.load("serverboards.secrets/sjcl.js").then(function(){console.log(sjcl),f.encrypt=sjcl.encrypt,f.decrypt=sjcl.decrypt});!function(){function e(e){this.value=e}function t(t){var r,n;function a(r,n){try{var i=t[r](n),l=i.value;l instanceof e?Promise.resolve(l.value).then(function(e){a("next",e)},function(e){a("throw",e)}):s(i.done?"return":"normal",i.value)}catch(e){s("throw",e)}}function s(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}(r=r.next)?a(r.key,r.arg):n=null}this._invoke=function(e,t){return new Promise(function(s,i){var l={key:e,arg:t,resolve:s,reject:i,next:null};n?n=n.next=l:(r=n=l,a(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var v=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},S=Serverboards,E=S.React,g=S.Flash,b=E.createClass({displayName:"EditSecret",componentDidMount:function(){$(this.refs.el).find(".ui.checkbox").checkbox()},handleEncrypt:function(){var e=this,t=$(this.refs.content).val(),r=$(this.refs.password).val(),n=$(this.refs.title).val();if(r)if(6>r.length)g.error("Password too short! At least 6 characters.");else if(r==$(this.refs.password_repeat).val()){var a={text:t,files:(this.props.files||[]).filter(function(t){return $(e.refs.el).find('input[type=checkbox][name="'+t.name+'"]').is(":checked")})||[]},s=[];if(0<this.refs.upload.files.length){var i=!0,l=!1,c=void 0;try{for(var o,d=function(){var e=o.value,t=new Promise(function(t){var r=new FileReader;r.onload=function(r){a.files.push({name:e.name,data:r.target.result,size:e.size}),t()},r.readAsDataURL(e)});console.log(s),s.push(t)},u=this.refs.upload.files[Symbol.iterator]();!(i=(o=u.next()).done);i=!0)d()}catch(e){l=!0,c=e}finally{try{!i&&u.return&&u.return()}finally{if(l)throw c}}}Promise.all(s).then(function(){var t=JSON.stringify(a),s=f.encrypt(r,t);e.props.onSave(n,s)})}else g.error("Passwords do not match!");else g.error("Cant use empty password.")},render:function(){var e=this.props;return E.createElement("div",{className:"ui text container"},E.createElement("div",{ref:"el",className:"ui form"},E.createElement("div",{className:"field"},E.createElement("label",null,"Secret Name"),E.createElement("input",{type:"text",ref:"title",defaultValue:e.title})),E.createElement("div",{className:"field"},E.createElement("label",null,"Text"),E.createElement("textarea",{id:"plain",ref:"content",style:{minHeight:"calc( 100vh - 33em )"},defaultValue:e.content})),E.createElement("div",{className:"field"},E.createElement("label",null,"Upload new file"),E.createElement("input",{type:"file",ref:"upload",multiple:!0}),0<(e.files||[]).length?E.createElement("div",null,E.createElement("label",null,"Files to keep"),E.createElement("div",{className:"ui meta"},"Unmark files to remove them from the secret"),E.createElement("div",{className:"ui three column grid"},(e.files||[]).map(function(e){return E.createElement("div",{className:"field column"},E.createElement("div",{className:"ui checkbox"},E.createElement("input",v({type:"checkbox",className:"ui checkbox",name:e.name,checked:!0},"className","hidden")),E.createElement("label",null,E.createElement(m,e))))}))):null),E.createElement("div",{className:"inline field"},E.createElement("label",null,"Password: "),E.createElement("input",{type:"password",defaultValue:e.password,ref:"password"}),E.createElement("label",null," Repeat Password: "),E.createElement("input",{type:"password",defaultValue:e.password,ref:"password_repeat"})," ",E.createElement("button",{className:"ui button yellow",onClick:this.handleEncrypt},"Encrypt"))))}}),y=Serverboards,x=y.React,w=y.Flash,N=Serverboards.Components.MarkdownPreview,k=x.createClass({displayName:"ViewSecret",getInitialState:function(){return{text:void 0,password:void 0,files:[],edit:!1}},handleOpenEdit:function(){this.setState({edit:!0})},handlePasswordSet:function(e){try{var t=JSON.parse(f.decrypt(e,this.props.secret));this.setState({text:t.text,password:e,files:t.files||[]}),this.props.onSecretVisible(!0)}catch(e){console.error(e),w.error("Invalid password. Try again.")}},componentWillReceiveProps:function(e){e.secret!=this.props.secret&&this.setState(this.getInitialState())},render:function(){var e=this.state;return e.edit?x.createElement(b,{password:e.password,content:e.text,title:this.props.title,onSave:this.props.onSave,files:this.state.files}):e.password?x.createElement("div",{className:"ui text container"},x.createElement(N,{value:e.text}),x.createElement("div",{className:"ui divider"}),0<e.files.length?x.createElement("div",null,"Attachments:",x.createElement("div",{className:"ui three column grid"},e.files.map(function(e){return x.createElement("a",{href:e.data,target:"_blank",download:e.name,key:e.name,className:"column"},x.createElement(m,e))})),x.createElement("div",{className:"ui divider"})):null,x.createElement("button",{style:{float:"right"},className:"ui button yellow",onClick:this.handleOpenEdit},"Edit")):x.createElement(i,{onPasswordSet:this.handlePasswordSet})}}),P=Serverboards,_=P.rpc,j=P.React,D=P.Flash,M=P.utils,C="serverboards.secrets",R=j.createClass({displayName:"View",getInitialState:function(){return{secrets:{},title:void 0,secret:void 0,secret_id:void 0,add:!1,visible:!1}},componentDidMount:function(){var e=this;if(_.call("plugin.data.list",[C,this.props.project+"."]).then(function(t){var r={},n=e.props.project.length+1;t.map(function(e){r[e]=e.slice(n)}),e.setState({secrets:r}),e.state.secret_id&&e.handleSecretSelect(e.state.secret_id),e.props.setSectionMenuProps({secrets:r})}),this.props.setSectionMenu){var t={secrets:[],title:this.state.title,secret:this.state.secret_id,onSecretSelect:this.handleSecretSelect.bind(this),onSecretAdd:this.handleAddSecretDialog.bind(this)};this.props.setSectionMenu(a,t)}},handleSecretSelect:function(e){var t=this;console.log("secret %o",e),_.call("plugin.data.get",[C,e]).then(function(r){var n=t.state.secrets[e];t.setState({secret:r,title:n,secret_id:e,add:!1,visible:!1}),t.props.setSectionMenuProps({title:n,secret:e,onDelete:t.state.visible&&t.handleDeleteSecret.bind(t)})})},handleAddSecretDialog:function(){this.setState({add:!0,title:"Add a new secret",secret_id:void 0})},handleAddSecret:function(e,t){var r=this,n=this,a=this.props.project+"."+e;_.call("plugin.data.update",[C,a,t]).then(function(s){var i;console.log("Saved encrypted data: %o: %o",e,s);var l=M.merge(r.state.secrets,v({},a,e));n.setState({add:!1,secret:t,title:e,secrets:l,secret_id:a}),n.props.setSectionMenuProps((v(i={title:e,secrets:l},"title",e),v(i,"onDelete",!1),i))}).catch(function(e){console.error(e),D.error("Could not save encrypted secret")})},handleDeleteSecret:function(){var e=this,t=this.state.secret_id;_.call("plugin.data.delete",[C,t]).then(function(){console.log("Deleted secret %o",t);var r={};Object.keys(e.state.secrets).map(function(n){n!=t&&(r[n]=e.state.secrets[n])}),e.setState({secret_id:void 0,secrets:r,secret:void 0,title:void 0,visible:!1}),e.props.setSectionMenuProps({secrets:r,title:void 0,onDelete:void 0})})},handleTitleChange:function(e,t,r){var n=this,a={};Object.keys(this.state.secrets).map(function(s){s==e?a[t]=r:a[s]=n.state.secrets[s]}),this.setState({secret_id:t,secrets:a,title:r})},handleSecretVisible:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];this.setState({visible:e}),this.props.setSectionMenuProps({onDelete:this.handleDeleteSecret.bind(this)})},handleSave:function(e,t){var r=this;_.call("plugin.data.update",[C,this.props.project+"."+e,t]).then(function(){if(e!=r.state.title)return _.call("plugin.data.delete",[C,r.props.project+"."+r.state.title])}).then(function(){return r.reload(r.props.project+"."+e)}).catch(function(e){console.error(e),D.error("Error saving secret")})},reload:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:void 0;this.setState(this.getInitialState()),this.setState({secret_id:e}),this.componentDidMount()},render:function(){this.props;var e=this.state;return j.createElement("div",{id:"secrets"},e.add?j.createElement(b,{onSave:this.handleAddSecret}):e.secret?j.createElement(k,{secret:e.secret,title:e.title,onSave:this.handleSave,onSecretChange:e.handleSecretSelect,onSecretVisible:this.handleSecretVisible,reload:this.reload}):j.createElement("div",{className:"ui text container"},"No secret selected. Select a secret from the top menu or add one."))}});Serverboards.add_screen(C+"/screen",function(e){var t=e.project,r=e.setSectionMenu,n=e.setSectionMenuProps;return j.createElement(R,{project:t.shortname,setSectionMenu:r,setSectionMenuProps:n})},{react:!0})});
