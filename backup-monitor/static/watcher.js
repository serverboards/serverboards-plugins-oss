'use strict';

var _Serverboards$1=Serverboards;
var rpc$1=_Serverboards$1.rpc;
function basename(a){var b=a.split('/');return 0==b.length?'':b[b.length-1]}// from MDN https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
function hex(a){var b=[],c=new DataView(a);for(var d=0;d<c.byteLength;d+=4){// Using getUint32 reduces the number of iterations needed (we process 4 bytes each time)
var f=c.getUint32(d),g=f.toString(16),h='00000000',j=(h+g).slice(-h.length);// toString(16) will give the hex representation of the number without padding
// We use concatenation and slice for padding
b.push(j)}// Join all the hex strings into one
return b.join('')}function old_backup(a){// must match today date or yesterdays
var b=new Date().toISOString().slice(0,10),c=new Date;c.setDate(c.getDate()-1);var d=c.toISOString().slice(0,10);return a==b||a==d}function get_servername(a){var b=new Promise(function(c,d){rpc$1.call('service.info',[a]).then(function(f){c(f.name)}).catch(function(f){d(f)})});return b}

var _Serverboards=Serverboards;
var React=_Serverboards.React;
var rpc=_Serverboards.rpc;
var plugin_id='serverboards.backup.monitor';
var Widget=Serverboards.React.createClass({getInitialState:function getInitialState(){return{files:[]}},componentDidMount:function componentDidMount(){var _this=this;rpc.call('rules.list',{serverboard:this.props.config.serverboard.shortname}).then(function(a){var b=a.filter(function(c){return plugin_id+'/file_exists'==c.trigger.trigger}).map(function(c){return{is_active:c.is_active,file_expression:c.trigger.params.file_expression,service_uuid:c.service,uuid:c.uuid}});_this.setState({files:b})})},render:function render(){this.props;var a=this.state;return React.createElement('table',{className:'ui very basic selectable table'},React.createElement('tbody',null,a.files.map(function(b){return React.createElement(BackupFileRow,{file:b})})))}});
var BackupFileRow=React.createClass({displayName:'BackupFileRow',getInitialState:function getInitialState(){var a=this.props.file;return{servername:void 0,filename:a.file_expression,datetime:void 0,color:a.is_active?'yellow':'grey',state:a.is_active?'Gathering information':'Not active',size:void 0}},componentDidMount:function componentDidMount(){var _this2=this,a=this.props.file;get_servername(this.props.file.service_uuid).then(function(c){_this2.setState({servername:c})}),console.log(a,a.file_expression+'-'+a.service_uuid);var b=new TextEncoder('utf-8').encode(a.file_expression+'-'+a.service_uuid);crypto.subtle.digest('SHA-256',b).then(function(c){var d='test-'+hex(c);return console.log(d),rpc.call('plugin.data_get',[plugin_id,d])}).then(function(c){if(!c.filename)return void _this2.setState({color:'red',state:'Cant get data from any backup. Maybe not performed yet?'});console.log(c);var d=old_backup(c.datetime);_this2.setState({filename:c.filename,datetime:c.datetime.slice(0,16).replace('T',' '),color:d?'red':'green',state:d?'Old backup. Check ASAP':'Ok',size:c.size})}).catch(function(c){console.error(c),_this2.setState({color:'red',state:c.toString()})})},render:function render(){var a=this.state;return React.createElement('tr',{style:{cursor:'pointer'}},React.createElement('td',{'data-tooltip':a.state,title:a.state,style:{paddingLeft:5}},React.createElement('i',{className:'ui label circular small '+a.color})),React.createElement('td',{style:{padding:'10px 0'}},React.createElement('div',{className:'ui oneline','data-tooltip':a.filename,title:a.filename,style:{maxWidth:150}},basename(a.filename||'')),React.createElement('div',{className:'ui meta'},a.servername)),React.createElement('td',null,React.createElement('div',{className:'ui oneline',style:{fontSize:'0.8em'}},a.datetime),React.createElement('b',null,a.size?a.size.toFixed(2)+' MB':'')))}});
function main(a,b){return Serverboards.ReactDOM.render(React.createElement(Widget,{config:b}),a),function(){Serverboards.ReactDOM.unmountComponentAtNode(a)}}Serverboards.add_widget(plugin_id+'/watcher',main);