{"version":3,"file":null,"sources":["../src/timeline.js","../src/widget.js"],"sourcesContent":["const {React, moment} = Serverboards\nconst {Calendar} = Serverboards.Components\n\nconst TimelineLine = React.createClass({\n  componentDidMount(){\n    $(this.refs.el).popup()\n  },\n  render(){\n    const {expiration, onClick, hasDivider, showCalendar, height} = this.props\n    const service = expiration.service\n    const date = moment(expiration.date)\n    const expired = date.isBefore(moment())\n    let style = {paddingLeft: 5, paddingBottom: \"1rem\", cursor: \"pointer\", maxHeight: height}\n    if (hasDivider){\n      style.borderTop=\"1px solid #eee\"\n      style.paddingTop=\"1rem\"\n    }\n    let tooltip={}\n    if (expiration.description){\n      tooltip[\"data-content\"]=expiration.description\n      tooltip[\"data-position\"]=\"bottom center\"\n    }\n    return (\n      <div className=\"row\" ref=\"el\"\n        key={`${service.uuid}/${expiration.name}/${expiration.date}/${expiration.id}`}\n        data-date={date.format(\"YYYY-MM-DD\")}\n        style={style}\n        onClick={() => showCalendar(date.year(), date.month())}\n        {...tooltip}\n        >\n          <div>\n            <a onClick={(ev) => onClick() && ev.stopPropagation()}><b>{service.name}</b></a> - {date.fromNow()}\n          </div>\n          <div>{expiration.name}</div>\n          <div className={expired ? \"ui text red\" : \"\"}>\n            {expired ? \"Expired\" : \"Expires\" } on {date.format(\"MMM Do, YY\")}\n          </div>\n      </div>\n    )\n  }\n})\n\nconst Timeline = React.createClass({\n  getInitialState(){\n    let marks = {}\n    const now = moment()\n    marks[now.format(\"YYYY-MM-DD\")]=\"bold text teal\"\n\n    for (let exp of this.props.expirations){\n      marks[moment(exp.date).format(\"YYYY-MM-DD\")]=\"background light grey\"\n    }\n\n    return {\n      marks,\n    }\n  },\n  gotoDate(date){\n    date=date.format(\"YYYY-MM-DD\")\n    const vel = $(this.refs.list).find(`[data-date=\"${date}\"]:first`)\n    const parent=vel.parent()\n    const offset=vel.offset().top - parent.offset().top + parent.scrollTop()\n    parent.scrollTop( offset )\n  },\n  showCalendar(year, month){\n    this.setState({year, month})\n  },\n  render(){\n    const {expirations, onShowService, height} = this.props\n    const state = this.state\n    return (\n      <div style={{maxHeight: height}}>\n        <div style={{minHeight: 200, display: \"flex\", margin: \"auto\"}}>\n          <Calendar marks={state.marks} navigation={true} onClick={this.gotoDate} month={this.state.month} year={this.state.year}/>\n        </div>\n        <div ref=\"list\" className=\"ui vertically divided list\" style={{overflow:\"auto\", maxHeight: height}}>\n          {expirations.map( (e, n) => (\n            <TimelineLine\n              key={`${e.service.uuid}/${e.check}`}\n              expiration={e}\n              onClick={() => onShowService(e.service.uuid)}\n              hasDivider={n!=0}\n              showCalendar={this.showCalendar}\n              />\n          ))}\n        </div>\n      </div>\n    )\n  }\n})\n\nexport default Timeline\n","const {event, plugin, React, store, cache, Flash, rpc, i18n} = Serverboards\nconst plugin_id=\"serverboards.expiration\"\nimport Timeline from './timeline'\nconst {Loading} = Serverboards.Components\nconst {merge} = Serverboards.utils\n\nconst Model = React.createClass({\n  getInitialState(){\n    const state = store.getState()\n    return {\n      updating: false,\n      expirations: undefined,\n      project: state.project.project,\n    }\n  },\n  componentDidMount(){\n    plugin.start_call_stop(\"serverboards.expiration/command\", \"list_expirations\", {project: this.state.project.shortname}\n      ).then( (expirations) => {\n        if (expirations.updating){\n          const update_id = event.on(`action.updated`, this.progressUpdate)\n          const stop_id = event.on(`action.stopped`, this.progressStop)\n          this.setState({updating: {id: expirations.updating, update_id, stop_id}})\n        }\n        else\n          this.setState( {expirations} )\n      }).catch( e => {\n        Flash.error(e)\n      })\n  },\n\n  progressUpdate(st){\n    let id = this.state.updating.id\n    if (id == st.uuid)\n      this.setState({updating: merge(this.state.updating, {progress: st.progress, label: st.label}) })\n  },\n  progressStop(st){\n    let id = this.state.updating.id\n    if (id == st.uuid){\n      this.componentWillUnmount() // to stop listening\n      this.setState({updating: false})\n      this.componentDidMount()\n    }\n  },\n  componentWillUnmount(){\n    if (this.state.updating){\n      event.off(`action.updated`, this.state.update_id)\n      event.off(`action.stopped`, this.state.stop_id)\n    }\n  },\n  handleShowService(serviceid){\n    store.goto(`/project/${this.state.project.shortname}/services/${serviceid}`)\n  },\n  handleReload(){\n    Flash.info(i18n(\"This will take long time\"))\n    rpc.call(\"action.trigger_wait\", [\"serverboards.expiration/update\", {}])\n      .then( () => { Flash.success(\"Expirations list updated\"); this.componentDidMount() } )\n      .catch( (e) => Flash.error(e) )\n  },\n  render(){\n    let olayout = this.props.layout\n    let layout\n    if (olayout.w==1 && olayout.h==2)\n      layout=\"small\"\n    else if (olayout.w > olayout.h)\n      layout=\"horizontal\"\n    else\n      layout=\"vertical\"\n\n    if (this.state.updating)\n      return (\n        <Loading>\n          {i18n(\"Updating expirations. This will take long time.\")}\n          <div className=\"ui text grey\">\n            {this.state.updating.label} ({(this.state.updating.progress || 0).toFixed(2)}%)\n          </div>\n        </Loading>\n      )\n    if (!this.state.expirations)\n      return (\n        <Loading>{i18n(\"Expirations\")}</Loading>\n      )\n    return (\n      <div className={`ui expirations ${layout}`} style={{maxHeight: olayout.height}}>\n        <Timeline\n          expirations={this.state.expirations}\n          onShowService={this.handleShowService}\n          height={olayout.height}\n          />\n        <button className=\"ui button yellow with icon\" onClick={this.handleReload}>\n          <i className=\"ui refresh icon\"/>\n        </button>\n      </div>\n    )\n  }\n})\n\n\nServerboards.add_widget(`${plugin_id}/widget`, Model, {react: true})\n"],"names":["Serverboards","React","moment","Calendar","Components","TimelineLine","createClass","componentDidMount","$","refs","el","popup","render","props","expiration","onClick","hasDivider","showCalendar","height","service","date","expired","isBefore","style","paddingLeft","paddingBottom","cursor","maxHeight","borderTop","paddingTop","description","tooltip","uuid","name","id","format","year","month","ev","stopPropagation","fromNow","Timeline","getInitialState","now","marks","expirations","exp","gotoDate","list","find","parent","vel","offset","top","scrollTop","setState","onShowService","state","minHeight","display","margin","overflow","map","e","n","check","event","plugin","store","cache","Flash","rpc","i18n","plugin_id","Loading","merge","utils","Model","getState","updating","project","start_call_stop","shortname","then","on","progressUpdate","stop_id","progressStop","update_id","catch","error","st","progress","label","componentWillUnmount","off","handleShowService","serviceid","goto","handleReload","info","call","success","layout","w","h","olayout","toFixed","add_widget","react"],"mappings":"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"}