{"version":3,"file":null,"sources":["../src/utils.js","../src/watcher.js"],"sourcesContent":["const {rpc} = Serverboards\n\nconst plugin_id = 'serverboards.backup.monitor'\n\nexport function basename(filepath){\n  var parts=filepath.split('/')\n  if (parts.length==0)\n    return ''\n  return parts[parts.length-1]\n}\n\n// from MDN https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest\nexport function hex(buffer) {\n  var hexCodes = [];\n  var view = new DataView(buffer);\n  for (var i = 0; i < view.byteLength; i += 4) {\n    // Using getUint32 reduces the number of iterations needed (we process 4 bytes each time)\n    var value = view.getUint32(i)\n    // toString(16) will give the hex representation of the number without padding\n    var stringValue = value.toString(16)\n    // We use concatenation and slice for padding\n    var padding = '00000000'\n    var paddedValue = (padding + stringValue).slice(-padding.length)\n    hexCodes.push(paddedValue);\n  }\n\n  // Join all the hex strings into one\n  return hexCodes.join(\"\");\n}\n\nexport function old_backup(date){\n  // must match today date or yesterdays\n  var today = (new Date()).toISOString().slice(0,10)\n  var yesterday_d = new Date()\n  yesterday_d.setDate(yesterday_d.getDate()-1)\n\n  var yesterday = yesterday_d.toISOString().slice(0,10)\n  return date == today || date == yesterday\n}\n\nexport function get_servername(uuid){\n  let p = new Promise(function(accept, reject){\n    rpc.call(\"service.get\", [uuid]).then( (service) => {\n      accept(service.name)\n    }).catch( (e) => {\n      reject( e )\n    })\n  })\n  return p\n}\n\n\nexport function get_state({file_expression, service}){\n  var to_check = new TextEncoder(\"utf-8\").encode(file_expression + \"-\" + service);\n  var p = crypto.subtle.digest(\"SHA-256\", to_check).then( (sha) => {\n    var key=\"test-\"+hex(sha)\n    return rpc.call(\"plugin.data.get\",[plugin_id, key])\n  } ).then( (data) => {\n    if (!data.filename){\n      return {\n        color: \"red\",\n        state: \"Cant get data from any backup. Maybe not performed yet?\"\n      }\n    }\n    const is_old = old_backup(data.datetime)\n    return {\n      filename: data.filename,\n      datetime: data.datetime.slice(0,16).replace('T',' '),\n      color: is_old ? \"red\" : \"green\",\n      state: is_old ? \"Old backup. Check ASAP\" : \"Ok\",\n      size: data.size,\n    }\n  }).catch((e) => {\n    console.error(e)\n    return {\n      color: \"red\",\n      state: e.toString()\n    }\n  })\n\n  return p\n}\n","import {basename, hex, get_state, get_servername} from './utils'\nconst {React, rpc, i18n} = Serverboards\n\nconst plugin_id = 'serverboards.backup.monitor'\n\nconst Widget = Serverboards.React.createClass({\n  getInitialState(){\n    return {\n      files:[]\n    }\n  },\n  componentDidMount(){\n    rpc.call(\"rules.list\", {project: this.props.project}).then( (list) => {\n      const files = list\n        .filter( (el) => el.trigger.trigger == `${plugin_id}/file_exists` && el.is_active )\n        .map( (el) => ({\n          is_active: el.is_active,\n          file_expression: el.trigger.params.file_expression,\n          service_uuid: el.service,\n          uuid: el.uuid\n        }))\n      this.setState({files})\n    })\n  },\n  render(){\n    const props=this.props\n    const state=this.state\n\n    if (state.files.length == 0){\n      return (\n        <div>\n          {i18n(\"No backups are being watched.\")}\n        </div>\n      )\n    }\n\n    return (\n      <table className=\"ui very basic selectable table\">\n        <tbody>\n          {state.files.map( (f) => (\n            <BackupFileRow file={f}/>\n          ))}\n        </tbody>\n      </table>\n    )\n  }\n})\n\n\nconst BackupFileRow = React.createClass({\n  getInitialState(){\n    const f = this.props.file\n    return {\n      servername: undefined,\n      filename: f.file_expression,\n      datetime: undefined,\n      color: 'blue',\n      state: 'Gathering information',\n      size: undefined,\n    }\n  },\n  componentDidMount(){\n    const f=this.props.file\n    get_servername(this.props.file.service_uuid).then( (servername) => {\n      this.setState({servername})\n    })\n    get_state({file_expression: f.file_expression, service: f.service_uuid}).then( (state) => this.setState(state) )\n  },\n  render(){\n    const state = this.state\n    return (\n      <tr style={{cursor:\"pointer\"}}>\n        <td style={{padding: \"10px 10px\"}}>\n          <div\n            className=\"ui oneline\"\n            data-tooltip={state.filename}\n            title={state.filename}\n            >\n            {state.filename}\n          </div>\n          <div className=\"ui meta\">{state.servername}</div>\n        </td>\n        <td style={{width:100}}>\n          {state.state == \"Ok\" ? (\n            <div><b style={{fontSize:\"1.1em\"}}>OK</b></div>\n          ) : (\n            <div className={`ui text ${state.color}`}><b>{state.state}</b></div>\n          )}\n          <div><b>{state.size ? `${state.size.toFixed(2)} MB` : ''}</b></div>\n          <div className=\"ui oneline\" style={{fontSize:\"12px\", color: \"#666\"}}>{state.datetime}</div>\n        </td>\n        <td title={state.state} style={{textAlign:\"right\"}} style={{width: 10, height: \"100%\"}}>\n          <i className={`ui label rectangular ${state.color}`}/>\n        </td>\n      </tr>\n    )\n  }\n})\n\nfunction main(el, config, {project}){\n  Serverboards.ReactDOM.render(React.createElement(Widget, {config, project}), el)\n\n  return function(){\n    Serverboards.ReactDOM.unmountComponentAtNode(el)\n  }\n}\n\nServerboards.add_widget(plugin_id+\"/watcher\", main)\n"],"names":["Serverboards","rpc","plugin_id","buffer","view","i","byteLength","getUint32","stringValue","value","toString","padding","paddedValue","slice","length","hexCodes","push","join","date","toISOString","yesterday_d","setDate","getDate","today","yesterday","uuid","accept","reject","call","then","service","name","catch","e","file_expression","to_check","encode","p","crypto","subtle","digest","sha","hex","key","data","filename","color","state","old_backup","datetime","replace","is_old","size","error","React","i18n","Widget","createClass","getInitialState","files","componentDidMount","project","props","list","filter","el","trigger","is_active","map","params","service_uuid","setState","render","f","BackupFileRow","file","servername","get_servername","get_state","cursor","width","fontSize","toFixed","textAlign","height","config","ReactDOM","createElement","unmountComponentAtNode","add_widget","main"],"mappings":"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"}